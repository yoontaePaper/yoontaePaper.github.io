<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Paper Management Assistant (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify for XSS Protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>
    <!-- Tagify for improved tag input -->
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', 'Noto Sans SC', sans-serif; }
        .filter-btn, .tag, .action-btn { transition: all 0.2s ease-in-out; cursor: pointer; }
        .filter-btn:hover, .tag:hover, .action-btn:hover { transform: scale(1.05); }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .memo-content-display h1, .memo-content-display h2, .memo-content-display h3 { font-weight: bold; margin-top: 0.5rem; margin-bottom: 0.25rem; }
        .memo-content-display h1 { font-size: 1.25rem; } .memo-content-display h2 { font-size: 1.1rem; }
        .memo-content-display ul { list-style-type: disc; margin-left: 1.5rem; }
        .memo-content-display a { color: #3b82f6; text-decoration: underline; }
        #paper-list.view-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem; }
        #paper-list.view-list { display: flex; flex-direction: column; gap: 1rem; }
        .filter-btn.active { background-color: #4f46e5; color: white; }
        .star-rating .star { color: #e5e7eb; } /* gray-200 */
        .star-rating .star.filled { color: #f59e0b; } /* amber-500 */
        .disabled-ui { opacity: 0.5; pointer-events: none; }
        /* Tagify custom styles */
        .tagify{ --tag-bg: #4f46e5; --tag-text-color: white; border-radius: 0.375rem; border-color: #d1d5db; }
        .tagify.tagify--focus { border-color: #4f46e5; }
        .tagify__input { margin: 0; }
        /* Accordion transition */
        #optional-fields { transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        #optional-fields.open { max-height: 1000px; opacity: 1; }
        .incomplete-indicator { cursor: help; margin-left: 0.25rem; }
        .tab-btn.active { border-color: #4f46e5; color: #4f46e5; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <div class="flex justify-between items-start">
                <!-- Auth Status -->
                <div id="auth-container" class="text-left">
                    <div id="user-info" class="hidden flex items-center gap-3">
                        <img id="user-photo" class="w-10 h-10 rounded-full">
                        <div>
                            <p id="user-name" class="font-semibold"></p>
                            <button id="logout-btn" class="text-sm text-red-500 hover:underline">Logout</button>
                        </div>
                    </div>
                    <button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                        Login with Google
                    </button>
                </div>

                <div class="text-center flex-grow">
                     <h1 class="text-4xl md:text-5xl font-bold text-indigo-600" data-lang-key="appTitle">My Paper Management Assistant</h1>
                     <p class="text-gray-500 mt-2" data-lang-key="appSubtitle">Maximize your research efficiency with importance management and powerful filtering.</p>
                </div>
                
                <!-- Language Switcher -->
                <div class="text-right">
                    <select id="language-switcher" class="bg-white border border-gray-300 rounded-md py-2 px-3 text-sm">
                        <option value="en">English</option>
                        <option value="zh">中文</option>
                        <option value="ko" selected>한국어</option>
                    </select>
                </div>
            </div>
        </header>

        <main id="paper-app" class="disabled-ui">
            <!-- Control Section -->
            <div class="mb-6 flex flex-wrap gap-4 justify-center items-center">
                <button id="toggle-form-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105" data-lang-key="addNewPaper">새 논문 추가</button>
                <button id="show-dashboard-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105" data-lang-key="showDashboard">대시보드 보기</button>
                <button id="export-csv-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105" data-lang-key="exportCSV">CSV 내보내기</button>
            </div>

            <!-- Paper Add/Edit Form Modal -->
            <div id="add-paper-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" style="display: none;">
                <div id="add-paper-form" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center p-6 border-b">
                        <h2 class="text-2xl font-bold" data-lang-key="formTitle">논문 정보 입력</h2>
                        <button id="close-form-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                    </div>

                    <div class="p-6 overflow-y-auto">
                        <!-- Input Mode Tabs -->
                        <div class="mb-6 border-b border-gray-200">
                            <nav class="flex -mb-px" aria-label="Tabs">
                                <button id="auto-complete-tab" class="tab-btn active w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm" data-lang-key="autoCompleteMode">자동 완성</button>
                                <button id="quick-add-tab" class="tab-btn w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-lang-key="quickAddMode">직접 입력</button>
                            </nav>
                        </div>

                        <div id="auto-complete-section">
                            <div class="bg-indigo-50 p-4 rounded-lg mb-6">
                                <h3 class="font-semibold text-indigo-800 mb-2" data-lang-key="autoCompleteTitle">🚀 정보 자동 완성 (Beta)</h3>
                                <div class="flex gap-2">
                                    <input type="text" id="api-query-input" class="flex-grow p-2 border-gray-300 rounded-md shadow-sm" data-lang-placeholder="autoCompletePlaceholder">
                                    <button id="fetch-api-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg" data-lang-key="fetch">가져오기</button>
                                </div>
                                <p id="api-status" class="text-sm mt-2"></p>
                            </div>
                        </div>

                        <form id="new-paper-form">
                            <input type="hidden" id="paper-id">
                            <!-- Essential Fields -->
                            <div class="space-y-6">
                                <div>
                                    <label for="title" class="block text-sm font-medium text-gray-700">
                                        <span data-lang-key="paperTitle">논문 제목</span>
                                        <span class="text-red-500 ml-1 text-xs font-normal" data-lang-key="titleRequiredNotice">(*논문 제목 입력은 필수입니다)</span>
                                    </label>
                                    <input type="text" id="title" required class="mt-1 p-2 w-full border-gray-300 rounded-md shadow-sm" data-lang-placeholder="titlePlaceholder">
                                </div>
                                <div>
                                    <label for="tags" class="block text-sm font-medium text-gray-700">
                                        <span data-lang-key="tags">태그</span>
                                        <span class="text-red-500 ml-1 text-xs font-normal" data-lang-key="tagRequiredNotice">(*태그 입력은 필수입니다)</span>
                                    </label>
                                    <input type="text" id="tags" required class="mt-1 p-2 w-full border-gray-300 rounded-md shadow-sm" data-lang-placeholder="tagsPlaceholder">
                                    <p id="tag-error-message" class="hidden text-xs text-red-600 mt-1" data-lang-key="tagRequired">태그는 필수 항목입니다.</p>
                                </div>
                                <div><label for="link" class="block text-sm font-medium text-gray-700" data-lang-key="paperLink">논문 링크 (URL)</label><input type="url" id="link" class="mt-1 p-2 w-full border-gray-300 rounded-md shadow-sm" data-lang-placeholder="linkPlaceholder"></div>
                            </div>
                            
                            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="flex items-center gap-4">
                                    <label for="status" class="block text-sm font-medium text-gray-700" data-lang-key="readStatus">읽기 상태</label>
                                    <select id="status" class="mt-1 w-full pl-3 pr-10 py-2 border-gray-300 rounded-md">
                                        <option value="To Read" data-lang-key="statusToRead">읽을 예정</option>
                                        <option value="Reading" data-lang-key="statusReading">읽는 중</option>
                                        <option value="Finished" data-lang-key="statusFinished">완독</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-4">
                                    <label for="importance" class="block text-sm font-medium text-gray-700" data-lang-key="importance">중요도</label>
                                    <select id="importance" class="mt-1 w-full pl-3 pr-10 py-2 border-gray-300 rounded-md">
                                        <option value="5" data-lang-key="impVeryHigh">★★★★★ (매우 중요)</option>
                                        <option value="4" data-lang-key="impHigh">★★★★☆ (중요)</option>
                                        <option value="3" selected data-lang-key="impMedium">★★★☆☆ (보통)</option>
                                        <option value="2" data-lang-key="impLow">★★☆☆☆ (낮음)</option>
                                        <option value="1" data-lang-key="impReference">★☆☆☆☆ (참고)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Accordion Toggle for Optional Fields -->
                            <div class="mt-6">
                                <button type="button" id="toggle-optional-fields-btn" class="w-full text-left font-semibold text-indigo-600 hover:text-indigo-800 p-2 rounded-md bg-gray-50 flex justify-between items-center">
                                    <span data-lang-key="showMoreOptions">추가 정보 입력</span>
                                    <svg id="optional-fields-arrow" class="w-5 h-5 transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>

                            <!-- Optional Fields (Collapsible) -->
                            <div id="optional-fields" class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-6">
                                <div><label for="journal" class="block text-sm font-medium text-gray-700" data-lang-key="journal">저널 / 컨퍼런스</label><input type="text" id="journal" class="mt-1 p-2 w-full border-gray-300 rounded-md shadow-sm"></div>
                                <div><label for="year" class="block text-sm font-medium text-gray-700" data-lang-key="year">발표 연도</label><input type="number" id="year" class="mt-1 p-2 w-full border-gray-300 rounded-md shadow-sm" data-lang-placeholder="yearPlaceholder"></div>
                                <div class="md:col-span-2">
                                    <label for="authors" class="block text-sm font-medium text-gray-700" data-lang-key="authors">저자</label>
                                    <input type="text" id="authors" class="mt-1 p-2 w-full border-gray-300 rounded-md shadow-sm" data-lang-placeholder="authorsPlaceholder">
                                    <p id="author-warning-message" class="hidden text-xs text-amber-600 mt-1" data-lang-key="toastAuthorWarning">⚠️ 자동 완성된 저자명은 간혹 정확하지 않을 수 있습니다. 다시 한번 확인해주세요.</p>
                                </div>
                            </div>
                             <div class="mt-8 pt-6 border-t text-right">
                                <button type="submit" id="save-paper-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md" data-lang-key="save">저장하기</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions Bar -->
            <div id="bulk-action-bar" class="hidden bg-gray-800 text-white p-3 rounded-xl mb-4 flex flex-col sm:flex-row items-center justify-between gap-4 shadow-lg sticky top-2 z-40">
                <div class="flex items-center font-semibold">
                    <span id="selection-count" class="mr-1">0</span>
                    <span data-lang-key="itemsSelected">개 항목 선택됨</span>
                </div>
                <div class="flex flex-wrap items-center justify-center gap-3">
                    <select id="bulk-action-select" class="bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-sm text-white">
                        <option value="" data-lang-key="bulkActionPrompt">-- 일괄 작업 선택 --</option>
                        <option value="change-importance" data-lang-key="bulkChangeImportance">중요도 변경</option>
                        <option value="add-tags" data-lang-key="bulkAddTags">태그 추가</option>
                        <option value="remove-tags" data-lang-key="bulkRemoveTags">태그 제거</option>
                        <option value="delete" data-lang-key="bulkDelete">선택 항목 삭제</option>
                    </select>
                    <div id="bulk-action-input-container" class="flex items-center gap-2">
                        <!-- Dynamic input will go here -->
                    </div>
                    <button id="bulk-apply-btn" class="bg-indigo-500 hover:bg-indigo-600 font-bold py-2 px-4 rounded-lg text-sm" data-lang-key="apply">적용</button>
                </div>
                <button id="bulk-cancel-btn" class="absolute top-2 right-3 text-gray-400 hover:text-white sm:static">&times;</button>
            </div>


            <!-- Paper List -->
            <div id="paper-list-container" class="bg-white p-6 rounded-xl shadow-lg">
                <!-- Search & Basic Filters -->
                <div class="flex flex-wrap gap-4 mb-4 items-end">
                    <div class="flex-grow min-w-[200px]"><label for="search-input" class="text-sm font-medium text-gray-700" data-lang-key="search">검색</label><input id="search-input" type="text" class="search w-full p-2 mt-1 border border-gray-300 rounded-lg" data-lang-placeholder="searchPlaceholder"></div>
                    <div>
                        <label for="filter-status" class="text-sm font-medium text-gray-700" data-lang-key="readStatus">읽기 상태</label>
                        <select id="filter-status" class="w-full p-2 mt-1 border border-gray-300 rounded-lg">
                            <option value="all" data-lang-key="filterAll">전체</option>
                            <option value="To Read" data-lang-key="statusToRead">읽을 예정</option>
                            <option value="Reading" data-lang-key="statusReading">읽는 중</option>
                            <option value="Finished" data-lang-key="statusFinished">완독</option>
                        </select>
                    </div>
                     <div>
                        <label for="sort-by" class="text-sm font-medium text-gray-700" data-lang-key="sortBy">정렬 기준</label>
                        <select id="sort-by" class="w-full p-2 mt-1 border border-gray-300 rounded-lg">
                            <option value="importance-desc" data-lang-key="sortImpDesc">중요도 높은 순</option>
                            <option value="importance-asc" data-lang-key="sortImpAsc">중요도 낮은 순</option>
                            <option value="year-desc" data-lang-key="sortYearDesc">최신순</option>
                            <option value="year-asc" data-lang-key="sortYearAsc">오래된 순</option>
                            <option value="title-asc" data-lang-key="sortTitleAsc">제목순 (A-Z)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700" data-lang-key="layout">레이아웃</label>
                        <div class="flex mt-1">
                            <button id="layout-list-btn" class="p-2 border border-gray-300 rounded-l-lg bg-indigo-500 text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg></button>
                            <button id="layout-grid-btn" class="p-2 border-t border-b border-r border-gray-300 rounded-r-lg bg-gray-200 text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg></button>
                        </div>
                    </div>
                </div>
                <!-- Multi-select Filters -->
                <div class="flex items-center gap-2 mb-4">
                    <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="select-all-checkbox" class="text-sm font-medium text-gray-700" data-lang-key="selectAll">모두 선택</label>
                </div>
                <div id="multi-filter-section" class="space-y-3 mb-4"></div>
                
                <ul id="paper-list" class="list view-list"></ul>
                <p id="no-papers" class="text-center text-gray-500 py-8" style="display: none;" data-lang-key="noPapers">저장된 논문이 없습니다.</p>
                <div id="login-prompt" class="text-center text-gray-500 py-8">Please log in to manage your papers.</div>
            </div>
        </main>
        
        <footer class="text-center py-8">
            <p class="mb-4 text-gray-600">If this website was helpful, please click the button below to support!</p>
            <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="yoontae" data-color="#FFDD00" data-emoji="☕"  data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#000000" data-coffee-color="#ffffff" ></script>
        </footer>

    </div>

    <!-- Modals -->
    <div id="dashboard-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-full overflow-y-auto p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-bold" data-lang-key="dashboardTitle">통계 대시보드</h2>
                <button id="close-dashboard-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-4 rounded-lg"><h3 class="font-bold text-center mb-2" data-lang-key="chartStatusDist">읽기 상태 분포</h3><canvas id="status-chart"></canvas></div>
                <div class="bg-gray-50 p-4 rounded-lg"><h3 class="font-bold text-center mb-2" data-lang-key="chartPapersByYear">연도별 논문 수</h3><canvas id="year-chart"></canvas></div>
                <div class="md:col-span-2 bg-gray-50 p-4 rounded-lg"><h3 class="font-bold text-center mb-2" data-lang-key="chartTopTags">상위 태그 (Top 5)</h3><canvas id="tags-chart"></canvas></div>
            </div>
        </div>
    </div>
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold mb-4" data-lang-key="deleteConfirmTitle">삭제 확인</h3>
            <p id="delete-confirm-message" data-lang-key="deleteConfirmMessage">정말로 삭제하시겠습니까?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-delete-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg" data-lang-key="cancel">취소</button>
                <button id="confirm-delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg" data-lang-key="delete">삭제</button>
            </div>
        </div>
    </div>
    <!-- Memo History Modal -->
    <div id="memo-history-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-bold" data-lang-key="memoHistoryTitle">메모 히스토리</h2>
                <button id="close-memo-history-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="memo-history-list" class="overflow-y-auto space-y-4">
                <!-- History items will be injected here -->
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot,
            query,
            orderBy,
            serverTimestamp,
            getDocs,
            writeBatch,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                // Fallback config, in case the environment variable is not set.
                apiKey: "AIzaSyCfn0BpuqPHN9ynZ6BiGEoOBgaif7FO690",
                authDomain: "paper-saver-df418.firebaseapp.com",
                projectId: "paper-saver-df418",
                storageBucket: "paper-saver-df418.firebasestorage.app",
                messagingSenderId: "23245752480",
                appId: "1:23245752480:web:48d71705302c2b703ea1c5",
                measurementId: "G-TL12FY1091"
            };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // setLogLevel('debug'); // Uncomment for detailed logs

        // --- GLOBAL STATE & ELEMENTS ---
        let currentUserId = null;
        let papersUnsubscribe = null; // To detach Firestore listener on logout
        let papers = []; // Master data array (source of truth from Firestore)
        let activeFilters = { tags: new Set(), journals: new Set(), years: new Set() };
        let deleteCallback = null;
        let charts = {};
        let currentLang = 'ko';
        let tagifyInstance = null; // To hold the Tagify instance
        let selectedPaperIds = new Set(); // For bulk actions
        let memoCache = {}; // Cache for memo subcollections
        let activeModal = null; // Track the currently open modal

        const dom = {
            paperApp: document.getElementById('paper-app'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            userInfo: document.getElementById('user-info'),
            userName: document.getElementById('user-name'),
            userPhoto: document.getElementById('user-photo'),
            loginPrompt: document.getElementById('login-prompt'),
            addPaperModal: document.getElementById('add-paper-modal'),
            addPaperForm: document.getElementById('add-paper-form'),
            toggleFormBtn: document.getElementById('toggle-form-btn'),
            closeFormBtn: document.getElementById('close-form-btn'),
            newPaperForm: document.getElementById('new-paper-form'),
            paperIdInput: document.getElementById('paper-id'),
            tagsInput: document.getElementById('tags'),
            tagErrorMessage: document.getElementById('tag-error-message'),
            saveBtn: document.getElementById('save-paper-btn'),
            noPapersMessage: document.getElementById('no-papers'),
            paperListContainer: document.getElementById('paper-list-container'),
            paperListUl: document.getElementById('paper-list'),
            searchInput: document.getElementById('search-input'),
            filterStatus: document.getElementById('filter-status'),
            sortBy: document.getElementById('sort-by'),
            multiFilterSection: document.getElementById('multi-filter-section'),
            exportCsvBtn: document.getElementById('export-csv-btn'),
            apiQueryInput: document.getElementById('api-query-input'),
            fetchApiBtn: document.getElementById('fetch-api-btn'),
            apiStatus: document.getElementById('api-status'),
            dashboardModal: document.getElementById('dashboard-modal'),
            showDashboardBtn: document.getElementById('show-dashboard-btn'),
            closeDashboardBtn: document.getElementById('close-dashboard-btn'),
            deleteConfirmModal: document.getElementById('delete-confirm-modal'),
            layoutListBtn: document.getElementById('layout-list-btn'),
            layoutGridBtn: document.getElementById('layout-grid-btn'),
            toggleOptionalFieldsBtn: document.getElementById('toggle-optional-fields-btn'),
            optionalFieldsDiv: document.getElementById('optional-fields'),
            optionalFieldsArrow: document.getElementById('optional-fields-arrow'),
            authorWarningMessage: document.getElementById('author-warning-message'),
            // Bulk Action Elements
            bulkActionBar: document.getElementById('bulk-action-bar'),
            selectionCount: document.getElementById('selection-count'),
            bulkActionSelect: document.getElementById('bulk-action-select'),
            bulkActionInputContainer: document.getElementById('bulk-action-input-container'),
            bulkApplyBtn: document.getElementById('bulk-apply-btn'),
            bulkCancelBtn: document.getElementById('bulk-cancel-btn'),
            selectAllCheckbox: document.getElementById('select-all-checkbox'),
            // Memo History Modal
            memoHistoryModal: document.getElementById('memo-history-modal'),
            closeMemoHistoryBtn: document.getElementById('close-memo-history-btn'),
            memoHistoryList: document.getElementById('memo-history-list'),
            // Form Mode Tabs
            autoCompleteTab: document.getElementById('auto-complete-tab'),
            quickAddTab: document.getElementById('quick-add-tab'),
            autoCompleteSection: document.getElementById('auto-complete-section'),
        };

        // --- I18N (Internationalization) ---
        const translations = {
            en: { appTitle: "My Paper Management Assistant", appSubtitle: "Maximize your research efficiency with importance management and powerful filtering.", addNewPaper: "Add New Paper", showDashboard: "View Dashboard", exportCSV: "Export CSV", formTitle: "Enter Paper Information", autoCompleteTitle: "🚀 Auto-Complete (Beta)", autoCompletePlaceholder: "arXiv, DOI, PMID, or paper title", fetch: "Fetch", paperTitle: "Paper Title", journal: "Journal / Conference", year: "Publication Year", yearPlaceholder: "YYYY", authors: "Authors", authorsPlaceholder: "Separate with commas (,)", paperLink: "Paper Link (URL)", tags: "Tags", tagsPlaceholder: "Type a tag and press Space or Enter", readStatus: "Read Status", statusToRead: "To Read", statusReading: "Reading", statusFinished: "Finished", importance: "Importance", impVeryHigh: "★★★★★ (Very High)", impHigh: "★★★★☆ (High)", impMedium: "★★★☆☆ (Medium)", impLow: "★★☆☆☆ (Low)", impReference: "★☆☆☆☆ (Reference)", save: "Save", saveChanges: "Save Changes", closeForm: "Close Form", search: "Search", searchPlaceholder: "Title, author, idea...", sortBy: "Sort By", sortImpDesc: "Importance High to Low", sortImpAsc: "Importance Low to High", sortYearDesc: "Newest First", sortYearAsc: "Oldest First", sortTitleAsc: "Title (A-Z)", layout: "Layout", filterAll: "All", filterTags: "Tags", filterJournals: "Journals", filterYears: "Years", noPapers: "No papers saved yet.", dashboardTitle: "Statistics Dashboard", chartStatusDist: "Read Status Distribution", chartPapersByYear: "Papers by Year", chartTopTags: "Top Tags (Top 5)", deleteConfirmTitle: "Confirm Deletion", deleteConfirmMessage: "Are you sure you want to delete this?", deleteConfirmMessageItem: "Are you sure you want to delete '{itemName}'?", deleteConfirmMessageBulk: "Are you sure you want to delete {count} selected items?", cancel: "Cancel", delete: "Delete", myIdea: "[ My Idea ]", bibtex: "[ BibTeX ]", editIdea: "Edit Idea (Markdown supported)", saveIdea: "Save Idea", linkToPaper: "Link to Paper", edit: "Edit", importanceTitle: "Importance: {level}", apiFetching: "Fetching information...", apiSuccess: "Successfully fetched info for '{title}'.", apiFail: "Failed to fetch information.", toastPaperAdded: "New paper has been added.", toastPaperUpdated: "Paper information has been updated.", toastPaperDeleted: "Paper has been deleted.", toastIdeaSaved: "Idea has been saved.", toastAutoCompleteSuccess: "Paper information has been auto-filled.", toastAutoCompleteFail: "Failed to auto-complete information.", toastCsvExported: "CSV file has been downloaded.", errorUpdate: "Error: Could not find the paper to update.", showMoreOptions: "Enter Additional Information", showLessOptions: "Hide Additional Information", selectAll: "Select All", itemsSelected: "items selected", bulkActionPrompt: "-- Select Bulk Action --", bulkChangeImportance: "Change Importance", bulkAddTags: "Add Tags", bulkRemoveTags: "Remove Tags", bulkDelete: "Delete Selected", apply: "Apply", toastBulkUpdated: "{count} items have been updated.", toastBulkDeleted: "{count} items have been deleted.", toastBulkError: "Bulk action failed.", bulkInputTagsPlaceholder: "Enter tags...", bulkInputRemoveTagsPlaceholder: "Tags to remove...", toastNoAction: "Please select an action.", toastNoValue: "Please provide a value for the action.", toastDuplicatePaper: "A paper with this title already exists.", memoHistoryTitle: "Memo History", viewHistory: "View History", noMemoHistory: "No memo history available.", tooltipIncomplete: "Incomplete. Please update later.", autoCompleteMode: "Auto-Complete", quickAddMode: "Quick Add", toastAuthorWarning: "⚠️ Auto-completed author names may be inaccurate. Please double-check.", tagRequired: "Tags are required.", tagRequiredNotice: "(*Tags are required)", titlePlaceholder: "Please enter the paper title", linkPlaceholder: "Please enter the URL", titleRequiredNotice: "(*Paper title is required)" },
            zh: { appTitle: "我的论文管理助手", appSubtitle: "通过重要性管理和强大的筛选功能，最大限度地提高您的研究效率。", addNewPaper: "添加新论文", showDashboard: "查看仪表板", exportCSV: "导出CSV", formTitle: "输入论文信息", autoCompleteTitle: "🚀 自动完成 (测试版)", autoCompletePlaceholder: "arXiv, DOI, PMID, 或论文标题", fetch: "获取", paperTitle: "论文标题", journal: "期刊 / 会议", year: "发表年份", yearPlaceholder: "YYYY", authors: "作者", authorsPlaceholder: "用逗号（,）分隔", paperLink: "论文链接 (URL)", tags: "标签", tagsPlaceholder: "输入标签后按空格或回车", readStatus: "阅读状态", statusToRead: "待读", statusReading: "在读", statusFinished: "已读", importance: "重要性", impVeryHigh: "★★★★★ (非常重要)", impHigh: "★★★★☆ (重要)", impMedium: "★★★☆☆ (中等)", impLow: "★★☆☆☆ (较低)", impReference: "★☆☆☆☆ (参考)", save: "保存", saveChanges: "保存更改", closeForm: "关闭表单", search: "搜索", searchPlaceholder: "标题、作者、想法...", sortBy: "排序方式", sortImpDesc: "重要性 高到低", sortImpAsc: "重要性 低到高", sortYearDesc: "最新优先", sortYearAsc: "最旧优先", sortTitleAsc: "标题 (A-Z)", layout: "布局", filterAll: "全部", filterTags: "标签", filterJournals: "期刊", filterYears: "年份", noPapers: "尚未保存任何论文。", dashboardTitle: "统计仪表板", chartStatusDist: "阅读状态分布", chartPapersByYear: "按年份统计的论文", chartTopTags: "热门标签 (前 5)", deleteConfirmTitle: "确认删除", deleteConfirmMessage: "您确定要删除吗？", deleteConfirmMessageItem: "您确定要删除“{itemName}”吗？", deleteConfirmMessageBulk: "您确定要删除所选的 {count} 个项目吗？", cancel: "取消", delete: "删除", myIdea: "[ 我的想法 ]", bibtex: "[ BibTeX ]", editIdea: "编辑想法 (支持Markdown)", saveIdea: "保存想法", linkToPaper: "论文链接", edit: "编辑", importanceTitle: "重要性: {level}", apiFetching: "正在获取信息...", apiSuccess: "成功获取“{title}”的信息。", apiFail: "获取信息失败。", toastPaperAdded: "新论文已添加。", toastPaperUpdated: "论文信息已更新。", toastPaperDeleted: "论文已删除。", toastIdeaSaved: "想法已保存。", toastAutoCompleteSuccess: "论文信息已自动填写。", toastAutoCompleteFail: "自动完成信息失败。", toastCsvExported: "CSV 文件已下载。", errorUpdate: "错误：找不到要更新的论文。", showMoreOptions: "输入附加信息", showLessOptions: "隐藏附加信息", selectAll: "全选", itemsSelected: "个项目已选择", bulkActionPrompt: "-- 选择批量操作 --", bulkChangeImportance: "更改重要性", bulkAddTags: "添加标签", bulkRemoveTags: "删除标签", bulkDelete: "删除所选", apply: "应用", toastBulkUpdated: "{count} 个项目已更新。", toastBulkDeleted: "{count} 个项目已删除。", toastBulkError: "批量操作失败。", toastNoAction: "请选择一个操作。", toastNoValue: "请为操作提供一个值。", toastDuplicatePaper: "已存在相同标题的论文。", memoHistoryTitle: "备忘录历史", viewHistory: "查看历史", noMemoHistory: "没有可用的备忘录历史。", tooltipIncomplete: "信息不完整。请稍后更新。", autoCompleteMode: "自动完成", quickAddMode: "快速添加", toastAuthorWarning: "⚠️ 自动完成的作者姓名可能不准确。请仔细检查。", tagRequired: "标签是必填项。", tagRequiredNotice: "(*标签为必填项)", titlePlaceholder: "请输入论文标题", linkPlaceholder: "请输入URL", titleRequiredNotice: "(*论文标题为必填项)" },
            ko: { appTitle: "나만의 논문 관리 도우미", appSubtitle: "중요도 관리와 강력한 필터링으로 연구 효율을 극대화하세요.", addNewPaper: "새 논문 추가", showDashboard: "대시보드 보기", exportCSV: "CSV 내보내기", formTitle: "논문 정보 입력", autoCompleteTitle: "🚀 정보 자동 완성 (Beta)", autoCompletePlaceholder: "arXiv, DOI, PMID, 또는 논문 제목", fetch: "가져오기", paperTitle: "논문 제목", journal: "저널 / 컨퍼런스", year: "발표 연도", yearPlaceholder: "YYYY", authors: "저자", authorsPlaceholder: "쉼표(,)로 구분", paperLink: "논문 링크 (URL)", tags: "태그", tagsPlaceholder: "태그 입력 후 스페이스바나 Enter를 누르세요", readStatus: "읽기 상태", statusToRead: "읽을 예정", statusReading: "읽는 중", statusFinished: "완독", importance: "중요도", impVeryHigh: "★★★★★ (매우 중요)", impHigh: "★★★★☆ (중요)", impMedium: "★★★☆☆ (보통)", impLow: "★★☆☆☆ (낮음)", impReference: "★☆☆☆☆ (참고)", save: "저장하기", saveChanges: "변경사항 저장", closeForm: "폼 닫기", search: "검색", searchPlaceholder: "제목, 저자, 아이디어...", sortBy: "정렬 기준", sortImpDesc: "중요도 높은 순", sortImpAsc: "중요도 낮은 순", sortYearDesc: "최신순", sortYearAsc: "오래된 순", sortTitleAsc: "제목순 (A-Z)", layout: "레이아웃", filterAll: "전체", filterTags: "태그", filterJournals: "학회/저널", filterYears: "연도", noPapers: "저장된 논문이 없습니다.", dashboardTitle: "통계 대시보드", chartStatusDist: "읽기 상태 분포", chartPapersByYear: "연도별 논문 수", chartTopTags: "상위 태그 (Top 5)", deleteConfirmTitle: "삭제 확인", deleteConfirmMessage: "정말로 삭제하시겠습니까?", deleteConfirmMessageItem: "'{itemName}' 논문을 삭제하시겠습니까?", deleteConfirmMessageBulk: "선택된 {count}개의 항목을 정말로 삭제하시겠습니까?", cancel: "취소", delete: "삭제", myIdea: "[ My Idea ]", bibtex: "[ BibTeX ]", editIdea: "아이디어 수정 (Markdown 지원)", saveIdea: "아이디어 저장", linkToPaper: "논문 링크", edit: "수정", importanceTitle: "중요도: {level}", apiFetching: "정보를 가져오는 중...", apiSuccess: "'{title}' 정보를 성공적으로 가져왔습니다.", apiFail: "정보를 가져오는데 실패했습니다.", toastPaperAdded: "새 논문이 추가되었습니다.", toastPaperUpdated: "논문 정보가 수정되었습니다.", toastPaperDeleted: "논문이 삭제되었습니다.", toastIdeaSaved: "아이디어가 저장되었습니다.", toastAutoCompleteSuccess: "논문 정보를 자동으로 채웠습니다.", toastAutoCompleteFail: "정보 자동 완성에 실패했습니다.", toastCsvExported: "CSV 파일이 다운로드되었습니다.", errorUpdate: "오류: 업데이트할 논문을 찾을 수 없습니다.", showMoreOptions: "추가 정보 입력", showLessOptions: "추가 정보 숨기기", selectAll: "모두 선택", itemsSelected: "개 항목 선택됨", bulkActionPrompt: "-- 일괄 작업 선택 --", bulkChangeImportance: "중요도 변경", bulkAddTags: "태그 추가", bulkRemoveTags: "태그 제거", bulkDelete: "선택 항목 삭제", apply: "적용", toastBulkUpdated: "{count}개의 항목이 수정되었습니다.", toastBulkDeleted: "{count}개의 항목이 삭제되었습니다.", toastBulkError: "일괄 작업에 실패했습니다.", toastNoAction: "작업을 선택해주세요.", toastNoValue: "작업에 필요한 값을 입력해주세요.", toastDuplicatePaper: "이미 동일한 제목의 논문이 존재합니다.", memoHistoryTitle: "메모 히스토리", viewHistory: "히스토리 보기", noMemoHistory: "메모 히스토리가 없습니다.", tooltipIncomplete: "정보가 부족합니다. 나중에 업데이트해주세요.", autoCompleteMode: "자동 완성", quickAddMode: "직접 입력", toastAuthorWarning: "⚠️ 자동 완성된 저자명은 간혹 정확하지 않을 수 있습니다. 다시 한번 확인해주세요.", tagRequired: "태그는 필수 항목입니다.", tagRequiredNotice: "(*태그 입력은 필수입니다)", titlePlaceholder: "논문 제목을 입력해주세요", linkPlaceholder: "URL을 입력해주세요", titleRequiredNotice: "(*논문 제목 입력은 필수입니다)" }
        };

        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-placeholder');
                 if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
            updateUI();
        }
        
        const statusKeyMap = { 'To Read': 'statusToRead', 'Reading': 'statusReading', 'Finished': 'statusFinished', '읽을 예정': 'statusToRead', '읽는 중': 'statusReading', '완독': 'statusFinished', '待读': 'statusToRead', '在读': 'statusReading', '已读': 'statusFinished' };
        const statusColors = { 'To Read': 'bg-yellow-100 text-yellow-800', 'Reading': 'bg-blue-100 text-blue-800', 'Finished': 'bg-green-100 text-green-800' };

        // --- LIST.JS INITIALIZATION ---
        const options = {
            valueNames: [ 'title', 'journal', 'year', 'authors', 'status', { name: 'tags-text', attr: 'data-tags' }, { name: 'id', attr: 'data-id' }, { name: 'importance', attr: 'data-importance' } ],
            item: '<li></li>' // Placeholder, we render manually
        };
        const paperList = new List('paper-list-container', options);

        // --- AUTHENTICATION ---
        const provider = new GoogleAuthProvider();

        const signInWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error signing in with Google:", error);
            }
        };

        const signOutUser = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out:", error);
            }
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                dom.userName.textContent = user.displayName;
                dom.userPhoto.src = user.photoURL;
                dom.userInfo.classList.remove('hidden');
                dom.loginBtn.classList.add('hidden');
                dom.paperApp.classList.remove('disabled-ui');
                dom.loginPrompt.style.display = 'none';
                loadPapersFromFirestore(currentUserId);
            } else {
                currentUserId = null;
                dom.userInfo.classList.add('hidden');
                dom.loginBtn.classList.remove('hidden');
                dom.paperApp.classList.add('disabled-ui');
                dom.loginPrompt.style.display = 'block';
                
                if (papersUnsubscribe) {
                    papersUnsubscribe();
                }
                papers = [];
                paperList.clear();
                updateUI();
            }
        });
        
        // --- DATA PERSISTENCE (FIRESTORE) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        function loadPapersFromFirestore(userId) {
            const papersCollection = collection(db, `artifacts/${appId}/users/${userId}/papers`);
            
            papersUnsubscribe = onSnapshot(papersCollection, (snapshot) => {
                papers = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        ...data,
                        'tags-text': data.tags,
                    };
                });
                
                memoCache = {}; // Clear memo cache on paper list refresh
                clearSelection();
                
                const listHtml = papers.map(p => renderPaperItem(p)).join('');
                dom.paperListUl.innerHTML = listHtml;

                paperList.reIndex();
                
                paperList.items.forEach(item => {
                    const id = item.elm.getAttribute('data-id');
                    const correspondingPaper = papers.find(p => p.id === id);
                    if (correspondingPaper) {
                        item.values(correspondingPaper);
                    }
                });

                updateUI();

            }, (error) => {
                console.error("Error fetching papers from Firestore:", error);
            });
        }

        // --- RENDER FUNCTIONS ---
        function renderPaperItem(values) {
            const statusColor = statusColors[values.status] || 'bg-gray-100 text-gray-800';
            const tagsHtml = (values['tags-text'] || '').split(',').map(tag => tag.trim() ? `<span class="tag bg-gray-200 text-gray-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">${tag.trim()}</span>` : '').join('');
            
            const importance = parseInt(values.importance, 10) || 3;
            const importanceTitle = translations[currentLang].importanceTitle.replace('{level}', importance);
            let starsHtml = `<div class="star-rating flex items-center" title="${importanceTitle}">`;
            for(let i = 1; i <= 5; i++) {
                starsHtml += `<svg class="w-4 h-4 star ${i <= importance ? 'filled' : ''}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
            }
            starsHtml += '</div>';
            
            const isIncomplete = values.isComplete === false; // Check for explicitly false
            const incompleteIndicator = isIncomplete ? `<span class="incomplete-indicator" title="${translations[currentLang].tooltipIncomplete}">⚠️</span>` : '';

            const itemActionsHtml = `<div class="mt-4"><div class="flex items-center gap-4"><button class="toggle-idea-btn action-btn text-sm font-semibold text-indigo-600 hover:text-indigo-800 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a5.5 5.5 0 00-5.5 5.5c0 2.236 1.344 4.145 3.25 5.022V16.5a.5.5 0 00.5.5h3.5a.5.5 0 00.5-.5v-2.478A5.495 5.495 0 0015.5 9 5.5 5.5 0 0010 3.5zM12 18H8v1h4v-1z" /><path d="M9.043 2.113a1 1 0 011.914 0l.83 1.66a1 1 0 00.957.69h1.74a1 1 0 01.707 1.707l-1.414 1.414a1 1 0 00-.293.957l.53 1.914a1 1 0 01-1.449 1.182l-1.559-.935a1 1 0 00-1.182 0l-1.559.935a1 1 0 01-1.449-1.182l.53-1.914a1 1 0 00-.293-.957L3.04 6.17a1 1 0 01.707-1.707h1.74a1 1 0 00.957-.69l.83-1.66z" /></svg><span data-lang-key="myIdea">${translations[currentLang].myIdea}</span></button><button class="bibtex-btn action-btn text-sm font-semibold text-teal-600 hover:text-teal-800 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg><span data-lang-key="bibtex">${translations[currentLang].bibtex}</span></button></div><div class="idea-section bg-gray-50 p-3 mt-2 rounded-md border" style="display: none;"><div class="memo-content-display prose prose-sm max-w-none mb-2 text-gray-700 border-b pb-2"></div><label class="block text-sm font-medium text-gray-700 mb-1" data-lang-key="editIdea">${translations[currentLang].editIdea}</label><textarea class="idea-textarea w-full p-2 border border-gray-300 rounded-md" rows="5"></textarea><div class="flex justify-end items-center mt-2 gap-2"><button class="view-memo-history-btn text-xs font-semibold text-gray-600 hover:text-gray-800 py-1 px-3" data-lang-key="viewHistory">${translations[currentLang].viewHistory}</button><button class="save-idea-btn bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-bold py-1 px-3 rounded-lg" data-lang-key="saveIdea">${translations[currentLang].saveIdea}</button></div></div><div class="bibtex-section bg-teal-50 p-3 mt-2 rounded-md border" style="display: none;"><pre class="bibtex-content text-teal-900 text-xs whitespace-pre-wrap font-mono"></pre></div></div>`;
            const statusLangKey = statusKeyMap[values.status] || 'statusToRead';
            const translatedStatus = translations[currentLang][statusLangKey];

            return `<li class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow flex items-start gap-4" data-id="${values.id}" data-importance="${values.importance}" data-tags="${values['tags-text'] || ''}">
                        <div class="flex-shrink-0 pt-1">
                            <input type="checkbox" class="paper-checkbox h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" data-id="${values.id}">
                        </div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start gap-2">
                                <div class="flex-grow">
                                    <div class="flex items-center gap-3 mb-1">${starsHtml}<h3 class="title text-lg font-bold text-indigo-700">${values.title}</h3>${incompleteIndicator}</div>
                                    <p class="journal text-gray-600 font-medium">${values.journal || 'N/A'} (<span class="year">${values.year || 'N/A'}</span>)</p>
                                    <p class="authors text-sm text-gray-500 italic">${values.authors || ''}</p>
                                </div>
                                <div class="flex flex-col items-end gap-2 flex-shrink-0">
                                    <button class="edit-btn text-gray-400 hover:text-indigo-600" title="${translations[currentLang].edit}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                                    <button class="delete-btn text-gray-400 hover:text-red-600" title="${translations[currentLang].delete}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                                </div>
                            </div>
                            <div class="mt-3 flex flex-wrap items-center gap-x-4 gap-y-2">
                                <span class="status ${statusColor} text-xs font-semibold px-2.5 py-0.5 rounded-full">${translatedStatus}</span>
                                ${values.link ? `<a href="${values.link}" target="_blank" class="text-sm text-blue-500 hover:underline" data-lang-key="linkToPaper">${translations[currentLang].linkToPaper}</a>` : ''}
                            </div>
                            <div class="mt-3 flex flex-wrap items-center gap-2">${tagsHtml}</div>
                            ${itemActionsHtml}
                        </div>
                    </li>`;
        }
        
        // --- UI UPDATE & CONTROL ---
        const updateUI = () => {
            updateMultiSelectFilters();
            updateList();
            updateBulkActionBar();
            dom.noPapersMessage.style.display = currentUserId && paperList.items.length === 0 ? 'block' : 'none';
        };

        function createFilterGroup(titleKey, category, items) {
            if (items.size === 0) return '';
            let buttons = '';
            Array.from(items).sort().forEach(item => {
                const isActive = activeFilters[category].has(item);
                buttons += `<button class="filter-btn text-xs font-semibold px-2.5 py-1 rounded-full ${isActive ? 'active' : 'bg-gray-200 hover:bg-gray-300'}" data-category="${category}" data-value="${item}">${item}</button>`;
            });
            return `<div class="flex flex-wrap items-center gap-2"><span class="font-semibold text-sm mr-2">${translations[currentLang][titleKey]}:</span>${buttons}</div>`;
        }

        function updateMultiSelectFilters() {
            const unique = {
                tags: new Set(papers.flatMap(p => (p['tags-text'] || '').split(',').map(t => t.trim()).filter(Boolean))),
                journals: new Set(papers.map(p => p.journal).filter(Boolean)),
                years: new Set(papers.map(p => p.year).filter(Boolean)),
            };
            dom.multiFilterSection.innerHTML = `${createFilterGroup('filterTags', 'tags', unique.tags)}${createFilterGroup('filterJournals', 'journals', unique.journals)}${createFilterGroup('filterYears', 'years', unique.years)}`;
        }
        
        const updateList = () => {
            paperList.filter(item => {
                const values = item.values();
                const statusFilterValue = dom.filterStatus.value;
                const statusMatch = statusFilterValue === 'all' || values.status === statusFilterValue;
                const journalMatch = activeFilters.journals.size === 0 || activeFilters.journals.has(values.journal);
                const yearMatch = activeFilters.years.size === 0 || activeFilters.years.has(String(values.year));
                const itemTagsText = item.elm.getAttribute('data-tags') || '';
                const paperTags = new Set(itemTagsText.split(',').map(t => t.trim()));
                const tagMatch = activeFilters.tags.size === 0 || [...activeFilters.tags].every(ft => paperTags.has(ft));
                return statusMatch && journalMatch && yearMatch && tagMatch;
            });
            const sortValue = dom.sortBy.value;
            const [sortBy, sortOrder] = sortValue.split('-');
            paperList.sort(sortBy, { order: sortOrder });
            paperList.search(dom.searchInput.value);
            dom.noPapersMessage.style.display = currentUserId && paperList.visibleItems.length === 0 ? 'block' : 'none';
        };

        function showToast(messageKey, type = 'success', replacements = {}) {
            let message = translations[currentLang][messageKey] || messageKey;
            for(const key in replacements) {
                message = message.replace(`{${key}}`, replacements[key]);
            }
            Toastify({ text: message, duration: 3000, gravity: "bottom", position: "right", style: { background: type === 'success' ? 'linear-gradient(to right, #00b09b, #96c93d)' : 'linear-gradient(to right, #ff5f6d, #ffc371)' } }).showToast();
        }

        // --- FORM HANDLING ---
        function clearAndResetForm() {
            dom.newPaperForm.reset();
            if (tagifyInstance) {
                tagifyInstance.removeAllTags();
            }
            dom.apiQueryInput.value = '';
            dom.apiStatus.textContent = '';
            dom.authorWarningMessage.classList.add('hidden');
            dom.tagErrorMessage.classList.add('hidden');
            if(tagifyInstance) tagifyInstance.DOM.scope.classList.remove('border-red-500');
            
            // Reset accordion
            dom.optionalFieldsDiv.classList.remove('open');
            dom.toggleOptionalFieldsBtn.querySelector('span').textContent = translations[currentLang].showMoreOptions;
            dom.optionalFieldsArrow.classList.remove('rotate-180');
        }

        function openForm(paper = null) {
            clearAndResetForm();
            
            if (tagifyInstance) {
                tagifyInstance.destroy();
            }
            tagifyInstance = new Tagify(dom.tagsInput, {
                placeholder: translations[currentLang].tagsPlaceholder,
                delimiters: ",| ",
            });
            tagifyInstance.on('input', () => {
                tagifyInstance.DOM.scope.classList.remove('border-red-500');
                dom.tagErrorMessage.classList.add('hidden');
            });

            document.getElementById('importance').value = 3; // default
            if (paper && paper.id) { // Edit mode
                dom.paperIdInput.value = paper.id;
                document.getElementById('title').value = paper.title;
                document.getElementById('journal').value = paper.journal;
                document.getElementById('year').value = paper.year;
                document.getElementById('authors').value = paper.authors;
                document.getElementById('link').value = paper.link;
                tagifyInstance.loadOriginalValues(paper.tags);
                document.getElementById('status').value = paper.status;
                document.getElementById('importance').value = paper.importance;
                dom.saveBtn.textContent = translations[currentLang].saveChanges;
                // Open accordion if editing
                dom.optionalFieldsDiv.classList.add('open');
                dom.toggleOptionalFieldsBtn.querySelector('span').textContent = translations[currentLang].showLessOptions;
                dom.optionalFieldsArrow.classList.add('rotate-180');
            } else { // Add mode
                dom.paperIdInput.value = '';
                dom.saveBtn.textContent = translations[currentLang].save;
            }
            openModal(dom.addPaperModal);
        }

        dom.newPaperForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) {
                showToast("Please log in to save papers.", "error");
                return;
            }

            // Tag validation
            if (tagifyInstance.value.length === 0) {
                tagifyInstance.DOM.scope.classList.add('border-red-500');
                dom.tagErrorMessage.classList.remove('hidden');
                return;
            }

            const paperId = dom.paperIdInput.value;
            const isUpdate = !!paperId;
            const yearValue = document.getElementById('year').value;
            const tagsFromTagify = tagifyInstance.value.map(tag => tag.value).join(',');

            const paperDataFromForm = {
                title: document.getElementById('title').value,
                journal: document.getElementById('journal').value,
                year: yearValue ? parseInt(yearValue, 10) : null,
                authors: document.getElementById('authors').value,
                tags: tagsFromTagify,
                link: document.getElementById('link').value,
                status: document.getElementById('status').value,
                importance: parseInt(document.getElementById('importance').value, 10),
            };
            
            // Set completion status
            paperDataFromForm.isComplete = !!(paperDataFromForm.authors && paperDataFromForm.journal && paperDataFromForm.year);

            // Check for duplicates before saving
            if (!isUpdate) {
                const newTitle = paperDataFromForm.title.trim().toLowerCase();
                if (papers.some(p => p.title.trim().toLowerCase() === newTitle)) {
                    showToast('toastDuplicatePaper', 'error');
                    return; // Prevent form submission
                }
            }

            try {
                if (isUpdate) {
                    const paperDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/papers`, paperId);
                    await updateDoc(paperDocRef, paperDataFromForm);
                    showToast('toastPaperUpdated');
                } else {
                    const papersCollection = collection(db, `artifacts/${appId}/users/${currentUserId}/papers`);
                    await addDoc(papersCollection, paperDataFromForm);
                    showToast('toastPaperAdded');
                }
            } catch (error) {
                console.error("Error saving paper to Firestore:", error);
                showToast("Failed to save paper.", "error");
            }

            closeModal(dom.addPaperModal);
            if (tagifyInstance) {
                tagifyInstance.destroy();
                tagifyInstance = null;
            }
        });
        
        // --- BULK ACTIONS ---
        function updateBulkActionBar() {
            const count = selectedPaperIds.size;
            if (count > 0) {
                dom.bulkActionBar.classList.remove('hidden');
                dom.selectionCount.textContent = count;
            } else {
                dom.bulkActionBar.classList.add('hidden');
            }
            // Sync "select all" checkbox state
            const visibleItems = paperList.visibleItems;
            const allVisibleSelected = visibleItems.length > 0 && visibleItems.every(item => selectedPaperIds.has(item.values().id));
            dom.selectAllCheckbox.checked = allVisibleSelected;
        }

        function clearSelection() {
            selectedPaperIds.clear();
            document.querySelectorAll('.paper-checkbox:checked').forEach(cb => cb.checked = false);
            updateBulkActionBar();
        }

        dom.bulkActionSelect.addEventListener('change', (e) => {
            const action = e.target.value;
            dom.bulkActionInputContainer.innerHTML = ''; // Clear previous input

            if (action === 'change-importance') {
                const importanceSelect = document.getElementById('importance').cloneNode(true);
                importanceSelect.id = 'bulk-importance-select';
                importanceSelect.classList.add('bg-gray-700', 'text-white', 'border-gray-600');
                dom.bulkActionInputContainer.appendChild(importanceSelect);
            } else if (action === 'add-tags' || action === 'remove-tags') {
                const tagInput = document.createElement('input');
                tagInput.type = 'text';
                tagInput.id = 'bulk-tag-input';
                tagInput.placeholder = translations[currentLang][action === 'add-tags' ? 'bulkInputTagsPlaceholder' : 'bulkInputRemoveTagsPlaceholder'];
                tagInput.className = 'bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-sm text-white w-full sm:w-auto';
                dom.bulkActionInputContainer.appendChild(tagInput);
            }
        });
        
        dom.bulkApplyBtn.addEventListener('click', async () => {
            const action = dom.bulkActionSelect.value;
            const count = selectedPaperIds.size;
            if (!action) {
                showToast('toastNoAction', 'error');
                return;
            }
            if (count === 0) return;

            const batch = writeBatch(db);
            let value;
            let actionSucceeded = true;

            try {
                switch (action) {
                    case 'delete':
                        const message = translations[currentLang].deleteConfirmMessageBulk.replace('{count}', count);
                        openDeleteModal(() => {
                            const deleteBatch = writeBatch(db);
                            selectedPaperIds.forEach(id => {
                                const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/papers`, id);
                                deleteBatch.delete(docRef);
                            });
                            deleteBatch.commit().then(() => {
                                showToast('toastBulkDeleted', 'success', { count });
                                clearSelection();
                            }).catch(e => { console.error(e); showToast('toastBulkError', 'error'); });
                        }, message);
                        return; // Return because modal is async

                    case 'change-importance':
                        value = document.getElementById('bulk-importance-select')?.value;
                        if (!value) { showToast('toastNoValue', 'error'); return; }
                        selectedPaperIds.forEach(id => {
                            const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/papers`, id);
                            batch.update(docRef, { importance: parseInt(value, 10) });
                        });
                        break;

                    case 'add-tags':
                    case 'remove-tags':
                        value = document.getElementById('bulk-tag-input')?.value.trim();
                        if (!value) { showToast('toastNoValue', 'error'); return; }
                        const tagsToChange = value.split(',').map(t => t.trim()).filter(Boolean);

                        selectedPaperIds.forEach(id => {
                            const paper = papers.find(p => p.id === id);
                            if (!paper) return;
                            const currentTags = new Set((paper.tags || '').split(',').map(t => t.trim()).filter(Boolean));
                            
                            if (action === 'add-tags') {
                                tagsToChange.forEach(t => currentTags.add(t));
                            } else { // remove-tags
                                tagsToChange.forEach(t => currentTags.delete(t));
                            }
                            
                            const newTags = Array.from(currentTags).join(',');
                            const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/papers`, id);
                            batch.update(docRef, { tags: newTags });
                        });
                        break;
                }
                
                await batch.commit();
                showToast('toastBulkUpdated', 'success', { count });

            } catch (error) {
                console.error("Bulk action failed:", error);
                showToast('toastBulkError', 'error');
                actionSucceeded = false;
            }

            if (actionSucceeded) {
                clearSelection();
            }
        });
        
        dom.bulkCancelBtn.addEventListener('click', clearSelection);

        dom.selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            paperList.visibleItems.forEach(item => {
                const id = item.values().id;
                const checkbox = dom.paperListUl.querySelector(`.paper-checkbox[data-id="${id}"]`);
                if (checkbox) {
                    checkbox.checked = isChecked;
                    if (isChecked) {
                        selectedPaperIds.add(id);
                    } else {
                        selectedPaperIds.delete(id);
                    }
                }
            });
            updateBulkActionBar();
        });


        // --- API & AUTO-FILL ---
        function fillForm(data) { 
            document.getElementById('title').value = data.title || ''; 
            document.getElementById('authors').value = data.authors ? data.authors.join(', ') : ''; 
            document.getElementById('year').value = data.year || ''; 
            document.getElementById('journal').value = data.journal || ''; 
            document.getElementById('link').value = data.link || ''; 
            dom.apiStatus.textContent = translations[currentLang].apiSuccess.replace('{title}', data.title); 
            showToast('toastAutoCompleteSuccess', 'info');
            dom.authorWarningMessage.classList.remove('hidden');
        }
        async function fetchFromCrossRef(doi) { const response = await fetch(`https://api.crossref.org/works/${encodeURIComponent(doi)}`); if (!response.ok) throw new Error('Crossref API request failed'); const data = await response.json(); const item = data.message; return { title: item.title ? item.title[0] : '', authors: item.author ? item.author.map(a => `${a.given} ${a.family}`) : [], year: item.issued ? item.issued['date-parts'][0][0] : '', journal: item['container-title'] ? item['container-title'][0] : '', link: item.URL || '' }; }
        async function fetchFromEuropePMC(pmid) { const response = await fetch(`https://www.ebi.ac.uk/europepmc/webservices/rest/search?query=EXT_ID:${encodeURIComponent(pmid)}&format=json`); if (!response.ok) throw new Error('Europe PMC API request failed'); const data = await response.json(); if (data.resultList.result.length === 0) throw new Error('Paper not found in Europe PMC'); const item = data.resultList.result[0]; return { title: item.title || '', authors: item.authorString ? item.authorString.split(',').map(s => s.trim()) : [], year: item.pubYear || '', journal: item.journalInfo ? item.journalInfo.journal.title : '', link: item.pmid ? `https://pubmed.ncbi.nlm.nih.gov/${item.pmid}/` : '' }; }
        async function fetchFromSemanticScholar(query) {
            let paperId = query;
            const match = query.match(/arxiv\.org\/(abs|pdf)\/(\d+\.\d+)/);
            if (match) {
                paperId = `arXiv:${match[2]}`;
            }
            const response = await fetch(`https://api.semanticscholar.org/v1/paper/${encodeURIComponent(paperId)}?fields=title,authors,year,venue,url`);
            if (!response.ok) throw new Error(`Semantic Scholar API error: ${response.statusText}`);
            const data = await response.json();
            return {
                title: data.title || '',
                // Robustly handle author data by filtering out invalid entries before mapping.
                authors: data.authors ? data.authors.filter(a => a && a.name).map(a => a.name) : [],
                year: data.year || '',
                journal: data.venue || '',
                link: data.url || ''
            };
        }
        dom.fetchApiBtn.addEventListener('click', async () => { const query = dom.apiQueryInput.value.trim(); if (!query) return; dom.apiStatus.textContent = translations[currentLang].apiFetching; try { let paperData; if (/^10\.\d{4,9}\/[-._;()/:A-Z0-9]+$/i.test(query)) { paperData = await fetchFromCrossRef(query); } else if (/^\d+$/.test(query)) { paperData = await fetchFromEuropePMC(query); } else { paperData = await fetchFromSemanticScholar(query); } fillForm(paperData); } catch (error) { console.error("API Fetch Error:", error); dom.apiStatus.textContent = translations[currentLang].apiFail; showToast('toastAutoCompleteFail', 'error'); } });

        // --- EVENT LISTENERS ---
        dom.loginBtn.addEventListener('click', signInWithGoogle);
        dom.logoutBtn.addEventListener('click', signOutUser);
        document.getElementById('language-switcher').addEventListener('change', (e) => setLanguage(e.target.value));
        dom.toggleFormBtn.addEventListener('click', () => openForm());
        dom.closeFormBtn.addEventListener('click', () => closeModal(dom.addPaperModal));
        dom.toggleOptionalFieldsBtn.addEventListener('click', () => {
            const isOpen = dom.optionalFieldsDiv.classList.toggle('open');
            dom.optionalFieldsArrow.classList.toggle('rotate-180', isOpen);
            dom.toggleOptionalFieldsBtn.querySelector('span').textContent = isOpen ? translations[currentLang].showLessOptions : translations[currentLang].showMoreOptions;
        });
        dom.searchInput.addEventListener('keyup', () => { updateList(); clearSelection(); });
        dom.filterStatus.addEventListener('input', () => { updateList(); clearSelection(); });
        dom.sortBy.addEventListener('input', () => { updateList(); clearSelection(); });
        dom.multiFilterSection.addEventListener('click', (e) => { if (e.target.classList.contains('filter-btn')) { const { category, value } = e.target.dataset; if (activeFilters[category].has(value)) { activeFilters[category].delete(value); } else { activeFilters[category].add(value); } updateMultiSelectFilters(); updateList(); clearSelection(); } });
        function generateBibtex(paper) { const authors = (paper.authors || '').split(',').map(name => name.trim()).join(' and '); const bibKey = `${(paper.authors || 'Unknown').split(',')[0].split(' ').pop()}${paper.year || 'N.D.'}`; return `@article{${bibKey.replace(/[^a-z0-9]/gi, '')},\n  author  = {${authors}},\n  title   = {${paper.title}},\n  journal = {${paper.journal}},\n  year    = {${paper.year}},\n  url     = {${paper.link}}\n}`; }

        dom.paperListUl.addEventListener('click', async (e) => {
            const listItem = e.target.closest('li');
            if (!listItem || !currentUserId) return;
            const paperId = listItem.getAttribute('data-id');
            const paper = papers.find(p => p.id.toString() === paperId.toString());
            
            if (e.target.classList.contains('paper-checkbox')) {
                const checkbox = e.target;
                if (checkbox.checked) {
                    selectedPaperIds.add(paperId);
                } else {
                    selectedPaperIds.delete(paperId);
                }
                updateBulkActionBar();
                return; // Stop further processing
            }

            if (!paper) return;

            if (e.target.closest('.delete-btn')) {
                const title = listItem.querySelector('.title').textContent;
                const message = translations[currentLang].deleteConfirmMessageItem.replace('{itemName}', title);
                openDeleteModal(async () => {
                    try {
                        const paperDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/papers`, paperId);
                        await deleteDoc(paperDocRef);
                        showToast('toastPaperDeleted', 'error');
                    } catch (error) {
                        console.error("Error deleting paper:", error);
                    }
                }, message);
            } else if (e.target.closest('.edit-btn')) {
                openForm(paper);
            } else if (e.target.closest('.save-idea-btn')) {
                const memoText = listItem.querySelector('.idea-textarea').value;
                const memosCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/papers`, paperId, 'memos');
                try {
                    await addDoc(memosCollectionRef, {
                        content: memoText,
                        timestamp: serverTimestamp()
                    });
                    delete memoCache[paperId]; // Invalidate cache
                    showToast('toastIdeaSaved');
                } catch (error) {
                    console.error("Error saving idea:", error);
                }
            } else if (e.target.closest('.toggle-idea-btn')) {
                const ideaSection = listItem.querySelector('.idea-section');
                const isVisible = ideaSection.style.display === 'block';
                if (isVisible) {
                    ideaSection.style.display = 'none';
                } else {
                    ideaSection.style.display = 'block';
                    const memoDisplay = listItem.querySelector('.memo-content-display');
                    const memoTextarea = listItem.querySelector('.idea-textarea');
                    
                    if (memoCache[paperId]) {
                        const latestMemo = memoCache[paperId][0];
                        if (latestMemo) {
                            memoDisplay.innerHTML = DOMPurify.sanitize(marked.parse(latestMemo.content || ''));
                            memoTextarea.value = latestMemo.content || '';
                        }
                    } else {
                        const memosCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/papers`, paperId, 'memos');
                        const q = query(memosCollectionRef, orderBy('timestamp', 'desc'));
                        const querySnapshot = await getDocs(q);
                        const memos = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        memoCache[paperId] = memos;
                        
                        const latestMemo = memos[0];
                        let content = '';
                        if (latestMemo) {
                            content = latestMemo.content || '';
                        } else if (paper.memo) { // Handle legacy memo field
                            content = paper.memo;
                        }
                        memoDisplay.innerHTML = DOMPurify.sanitize(marked.parse(content));
                        memoTextarea.value = content;
                    }
                }
            } else if (e.target.closest('.view-memo-history-btn')) {
                const memos = memoCache[paperId] || [];
                dom.memoHistoryList.innerHTML = ''; // Clear previous history
                if (memos.length > 0) {
                    memos.forEach(memo => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'p-3 border rounded-md bg-gray-50';
                        const timestamp = memo.timestamp ? memo.timestamp.toDate().toLocaleString() : 'N/A';
                        historyItem.innerHTML = `
                            <p class="text-xs text-gray-500 font-semibold mb-2">${timestamp}</p>
                            <div class="prose prose-sm max-w-none">${DOMPurify.sanitize(marked.parse(memo.content || ''))}</div>
                        `;
                        dom.memoHistoryList.appendChild(historyItem);
                    });
                } else {
                    dom.memoHistoryList.innerHTML = `<p class="text-gray-500" data-lang-key="noMemoHistory">${translations[currentLang].noMemoHistory}</p>`;
                }
                openModal(dom.memoHistoryModal);
            } else if (e.target.closest('.bibtex-btn')) { const bibtexSection = listItem.querySelector('.bibtex-section'); if (bibtexSection) { const isVisible = bibtexSection.style.display === 'block'; if (isVisible) { bibtexSection.style.display = 'none'; } else { const bibtexContent = bibtexSection.querySelector('.bibtex-content'); bibtexContent.textContent = generateBibtex(paper); bibtexSection.style.display = 'block'; } }
            } else if (e.target.closest('.tag')) { const tagName = e.target.closest('.tag').textContent.trim(); const filterButton = dom.multiFilterSection.querySelector(`.filter-btn[data-category='tags'][data-value='${tagName}']`); if (filterButton) filterButton.click(); }
        });
        
        // --- MODAL HANDLING & ESC KEY ---
        function openModal(modalElement) {
            if (!modalElement) return;
            modalElement.style.display = 'flex';
            document.body.classList.add('overflow-hidden');
            activeModal = modalElement;
        }

        function closeModal(modalElement) {
            if (!modalElement) return;
            modalElement.style.display = 'none';
            document.body.classList.remove('overflow-hidden');
            activeModal = null;
        }

        dom.showDashboardBtn.addEventListener('click', () => openModal(dom.dashboardModal));
        dom.closeDashboardBtn.addEventListener('click', () => closeModal(dom.dashboardModal));
        dom.closeMemoHistoryBtn.addEventListener('click', () => closeModal(dom.memoHistoryModal));
        document.getElementById('cancel-delete-btn').addEventListener('click', () => closeModal(dom.deleteConfirmModal));
        document.getElementById('confirm-delete-btn').addEventListener('click', () => { 
            if (deleteCallback) deleteCallback(); 
            closeModal(dom.deleteConfirmModal);
        });

        function openDeleteModal(callback, message) { 
            document.getElementById('delete-confirm-message').textContent = message; 
            deleteCallback = callback; 
            openModal(dom.deleteConfirmModal); 
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && activeModal) {
                closeModal(activeModal);
            }
        });

        // --- FORM MODE TABS ---
        function setFormMode(mode) {
            if (mode === 'auto') {
                dom.autoCompleteTab.classList.add('active');
                dom.autoCompleteTab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                dom.quickAddTab.classList.remove('active');
                dom.quickAddTab.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                dom.autoCompleteSection.style.display = 'block';
            } else { // 'quick'
                dom.quickAddTab.classList.add('active');
                dom.quickAddTab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                dom.autoCompleteTab.classList.remove('active');
                dom.autoCompleteTab.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                dom.autoCompleteSection.style.display = 'none';
            }
        }
        dom.autoCompleteTab.addEventListener('click', () => {
            setFormMode('auto');
            clearAndResetForm();
        });
        dom.quickAddTab.addEventListener('click', () => {
            setFormMode('quick');
            clearAndResetForm();
        });

        // --- LAYOUT PERSISTENCE ---
        dom.layoutListBtn.addEventListener('click', () => { setLayout('list'); localStorage.setItem('paperAppLayout', 'list'); });
        dom.layoutGridBtn.addEventListener('click', () => { setLayout('grid'); localStorage.setItem('paperAppLayout', 'grid'); });

        function setLayout(layout) {
            if (layout === 'grid') {
                dom.paperListUl.className = 'list view-grid';
                dom.layoutGridBtn.classList.add('bg-indigo-500', 'text-white');
                dom.layoutGridBtn.classList.remove('bg-gray-200', 'text-gray-700');
                dom.layoutListBtn.classList.add('bg-gray-200', 'text-gray-700');
                dom.layoutListBtn.classList.remove('bg-indigo-500', 'text-white');
            } else { // 'list'
                dom.paperListUl.className = 'list view-list';
                dom.layoutListBtn.classList.add('bg-indigo-500', 'text-white');
                dom.layoutListBtn.classList.remove('bg-gray-200', 'text-gray-700');
                dom.layoutGridBtn.classList.add('bg-gray-200', 'text-gray-700');
                dom.layoutGridBtn.classList.remove('bg-indigo-500', 'text-white');
            }
        }

        function applySavedLayout() {
            const savedLayout = localStorage.getItem('paperAppLayout') || 'list';
            setLayout(savedLayout);
        }
        
        dom.exportCsvBtn.addEventListener('click', () => { const headers = ['id', 'title', 'journal', 'year', 'authors', 'link', 'tags', 'status', 'importance', 'memo']; const csvRows = [ headers.join(','), ...papers.map(row => headers.map(header => { let cell = row[header] === null || row[header] === undefined ? '' : String(row[header]); const result = cell.replace(/"/g, '""'); return result.includes(',') ? `"${result}"` : result; }).join(',')) ]; const csvString = csvRows.join('\n'); const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `papers_${new Date().toISOString().slice(0,10)}.csv`; link.click(); URL.revokeObjectURL(link.href); showToast('toastCsvExported', 'info'); });

        // --- Dashboard Chart Rendering ---
        function renderDashboard() { if (charts.statusChart) charts.statusChart.destroy(); if (charts.yearChart) charts.yearChart.destroy(); if (charts.tagsChart) charts.tagsChart.destroy(); const statusCounts = papers.reduce((acc, p) => { acc[p.status] = (acc[p.status] || 0) + 1; return acc; }, {}); const translatedStatusLabels = Object.keys(statusCounts).map(status => translations[currentLang][statusKeyMap[status]]); charts.statusChart = new Chart(document.getElementById('status-chart'), { type: 'pie', data: { labels: translatedStatusLabels, datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#fef08a', '#bfdbfe', '#bbf7d0'] }] } }); const yearCounts = papers.reduce((acc, p) => { if(p.year) acc[p.year] = (acc[p.year] || 0) + 1; return acc; }, {}); const sortedYears = Object.keys(yearCounts).sort((a,b) => a - b); charts.yearChart = new Chart(document.getElementById('year-chart'), { type: 'bar', data: { labels: sortedYears, datasets: [{ label: translations[currentLang].chartPapersByYear, data: sortedYears.map(y => yearCounts[y]), backgroundColor: '#818cf8' }] } }); const tagCounts = papers.flatMap(p => (p.tags || '').split(',').map(t => t.trim()).filter(Boolean)).reduce((acc, tag) => { acc[tag] = (acc[tag] || 0) + 1; return acc; }, {}); const sortedTags = Object.entries(tagCounts).sort(([,a],[,b]) => b-a).slice(0, 5); charts.tagsChart = new Chart(document.getElementById('tags-chart'), { type: 'bar', data: { labels: sortedTags.map(([tag]) => tag), datasets: [{ label: translations[currentLang].tags, data: sortedTags.map(([,count]) => count), backgroundColor: '#f472b6' }] }, options: { indexAxis: 'y' } }); }
        
        // --- INITIAL LOAD ---
        async function initialize() {
            setLanguage('ko'); // Set default language
            applySavedLayout(); // Apply saved layout on page load
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    console.log("No initial auth token. Waiting for user to log in.");
                }
            } catch (error) {
                console.error("Error during initial sign-in:", error);
            }
        }
        
        initialize();

    </script>
</body>
</html>
